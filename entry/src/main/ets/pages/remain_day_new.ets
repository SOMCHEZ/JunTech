import router from '@ohos.router';
import http from '@ohos.net.http';
import { dataSharePredicates } from '@kit.ArkData';
import picker from '@ohos.file.picker';
import photoAccessHelper from '@ohos.file.photoAccessHelper';
import { prompt } from '@kit.ArkUI';

//æ°¸ä¹…å­˜å‚¨tokenå’Œç§Ÿæˆ·id
AppStorage.setOrCreate('token', '');
AppStorage.setOrCreate('tenantId', 0);

interface RouteParams {
  token?: string;
  relTenantIds?: number;
  formData?: SampleFormData;
}

interface SampleFormData {
  id?: string;
  unitName?: string;
  date?: string;
  sampleType?: string;
  mealType?: string;
  fridgeTemp?: string;
  dishName?: string;
  sampleWeight?: string;
  destroyPerson?: string;
  destroyTime?: string;
  sampleImages?: string[];
  fridgeImages?: string[];
  remark?: string;
}

interface SampleResponse {
  code: number;
  message: string;
  result: SampleFormData;
  timestamp: number;
}

@Entry
@Component
struct SampleFormPage {
  @State samples: SampleFormData[] = [];
  @State submitUnit: string = 'å®è®­ç¬¬äºŒå­¦æ ¡é¤å…'
  @State sampleDate: string = 'è¯·é€‰æ‹©æ—¥æœŸ'
  @State sampleType: string = 'ä¸åŒºåˆ†'
  @State mealType: string = 'åˆé¤'
  @State fridgeTemp: string = '5'
  @State dishName: string = ''
  @State sampleWeight: string = ''
  @State destroyPerson: string = ''
  @State destroyTime: string = 'è¯·é€‰æ‹©é”€æ¯æ—¶é—´'
  @State sampleImages: string[] = []
  @State fridgeImages: string[] = []
  @State remark: string = ''
  @State receivedToken: string = ''
  @State tenantId: number = 0

  @State photoUri: string = '';
  @State formDataList: SampleFormData[] = [];
  private photoPicker = new picker.PhotoViewPicker();
  @State photoAssetUrl:string = ''
  private photoCount: number = 0

  private unitOptions: string[] = ['å®è®­ç¬¬äºŒå­¦æ ¡é¤å…', 'å…¶ä»–']
  private typeOptions: string[] = ['ä¸åŒºåˆ†', 'æ•™å¸ˆé¤', 'å­¦ç”Ÿé¤']
  private mealOptions: string[] = ['æ—©é¤', 'åˆé¤', 'æ™šé¤','æ—©ç‚¹','åˆç‚¹','æ™šç‚¹','å…¶ä»–','è¥å…»æ”¹å–„è®¡åˆ’']
  private destroyTimeOptions: string[] = ['ä¸Šåˆ', 'ä¸‹åˆ', 'æ™šä¸Š']

  build() {
    Column() {
      Scroll() {
        Column() {
          // é¡¶éƒ¨æç¤º
          Text('æ ¹æ®æ”¿ç­–è¦æ±‚ï¼Œæ ·æœ¬é‡é‡ä¸å°‘äº125å…‹ï¼Œä¸”è¯¥ç•™æ ·æ—¶é—´å¿…é¡»åœ¨48å°æ—¶ä»¥ä¸Šã€‚é¢„è®¡è¯¥æ ·æœ¬åœ¨2025å¹´05æœˆ11æ—¥åå¯ä»¥é”€æ¯ã€‚')
            .fontColor('#FF7F50')
            .fontSize(15)
            .margin({ bottom: 16, top: 8 })

          // æäº¤å•ä½
          Row() {
            this.formRow('æäº¤å•ä½', true)
            Select(this.unitOptions.map<SelectOption>(item => ({ value: item })))
              .value(this.submitUnit)
              .onSelect(index => this.submitUnit = this.unitOptions[index])
              .width('65%')
          }
          .margin({top: 5, bottom: 5 })

          // ç•™æ ·æ—¥æœŸ
          Row(){
            this.formRow('ç•™æ ·æ—¥æœŸ', true)
            Text(this.sampleDate)
              .onClick(() => this.showDatePicker())
              .fontColor(this.sampleDate === 'è¯·é€‰æ‹©æ—¥æœŸ' ? '#bbb' : '#222')
              .width('65%')
              .margin({left:'5%'})
          }
          .margin({top: 5, bottom: 5 })

          // ç•™æ ·ç±»å‹
          Row() {
            this.formRow('ç•™æ ·ç±»å‹', true)
            Select(this.typeOptions.map<SelectOption>(item => ({ value: item })))
              .value(this.sampleType)
              .onSelect(index => this.sampleType = this.typeOptions[index])
              .width('65%')
          }
          .margin({top: 5, bottom: 5 })

          // é¤åˆ«
          Row() {
            this.formRow('é¤    åˆ«', true)
            Select(this.mealOptions.map<SelectOption>(item => ({ value: item })))
              .value(this.mealType)
              .onSelect(index => this.mealType = this.mealOptions[index])
              .width('65%')
          }
          .margin({top: 5, bottom: 5 })

          // ç•™æ ·æŸœæ¸©åº¦
          Row(){
            this.formRow('ç•™æ ·æŸœæ¸©åº¦â„ƒ', true)
            TextInput({ placeholder: '5' })
              .type(InputType.Number)
              .onChange(val => this.fridgeTemp = val)
              .width('100%')
          }
          .margin({top: 5, bottom: 5 })

          // èœå“åç§°
          Row(){
            this.formRow('èœå“åç§°', true)
            TextInput({ placeholder: 'è¯·è¾“å…¥èœå“åç§°' })
              .onChange(val => this.dishName = val)
              .width('100%')
          }
          .margin({top: 5, bottom: 5 })

          // ç•™æ ·é‡é‡
          Row(){
            this.formRow('ç•™æ ·é‡é‡(å…‹)', true)
            TextInput({ placeholder: 'è¯·è¾“å…¥ç•™æ ·é‡é‡' })
              .type(InputType.Number)
              .onChange(val => this.sampleWeight = val)
              .width('100%')
          }
          .margin({top: 5, bottom: 5 })

          // é”€æ¯äººå‘˜
          Row(){
            this.formRow('é”€æ¯äººå‘˜', true)
            TextInput({ placeholder: 'è¯·è¾“å…¥é”€æ¯äººå‘˜' })
              .onChange(val => this.destroyPerson = val)
              .width('100%')
          }
          .margin({top: 5, bottom: 5 })

          // é”€æ¯æ—¶é—´
          Row(){

            this.formRow('é”€æ¯æ—¶é—´', false)
            Text(this.destroyTime)
              .onClick(()=>this.destroyTimePicker())
              .fontColor(this.destroyTime === 'è¯·é€‰æ‹©é”€æ¯æ—¶é—´' ? '#bbb' : '#222')
              .width('65%')
              .margin({left:'5%'})
          }
          .margin({top: 5, bottom: 5 })

          // ä¸Šä¼ ç•™æ ·å›¾ç‰‡
          this.formImageRow('ä¸Šä¼ ç•™æ ·å›¾ç‰‡', true, this.sampleImages, 10, (imgs: string[]) => this.sampleImages = imgs)
          // æ”¾å…¥ç•™æ ·æŸœæ‹ç…§
          this.formImageRow('æ”¾å…¥ç•™æ ·æŸœæ‹ç…§', true, this.fridgeImages, 2, (imgs: string[]) => this.fridgeImages = imgs)

          // å¤‡æ³¨
          Column() {
            Text('å¤‡æ³¨').fontWeight(FontWeight.Bold).margin({ top: 16, bottom: 4 })
            TextInput({ placeholder: 'è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯' })
              .onChange(val => this.remark = val)
              .width('100%')
          }
        }
        .padding(16)
        .width('110%')
      }
      .layoutWeight(1)

      // æäº¤æŒ‰é’®
      Button('æäº¤')
        .width('100%')
        .height(48)
        .backgroundColor('#07C160')
        .fontColor('#fff')
        .fontSize(20)
        .margin({ top: 24, bottom: 24 })
        .onClick(() => this.submit())

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#fff')
  }

  async onPageShow() {
    const params = router.getParams() as RouteParams;

    if (!AppStorage.get('token') && params?.token) {
      AppStorage.set('token', params.token);
    }
    if (!AppStorage.get('tenantId') && params?.relTenantIds) {
      AppStorage.set('tenantId', params.relTenantIds);
    }

    this.receivedToken = AppStorage.get('token') ?? '';
    this.tenantId = AppStorage.get('tenantId') ?? 0;

    console.log('Received form data:', params.formData)
    if (params?.formData) {
      // ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……è¡¨å•æ•°æ®
      const formData = params.formData;
      this.sampleDate = formData.date ?? 'è¯·é€‰æ‹©æ—¥æœŸ';
      this.sampleType = formData.sampleType ?? 'ä¸åŒºåˆ†';
      this.mealType = formData.mealType ?? 'åˆé¤';
      this.dishName = formData.dishName ?? '';
      this.sampleWeight = formData.sampleWeight ?? '';
      this.destroyPerson = formData.destroyPerson ?? '';
      this.destroyTime = formData.destroyTime ?? 'è¯·é€‰æ‹©é”€æ¯æ—¶é—´';
      this.sampleImages = formData.sampleImages ?? [];
      this.fridgeImages = formData.fridgeImages ?? [];
      this.remark = formData.remark ?? '';
    }
  }
  // æ·»åŠ å›¾ç‰‡
  private async openGallery() {
    try {
      const photoSelectResult = await this.photoPicker.select();
      if (photoSelectResult && photoSelectResult.photoUris && photoSelectResult.photoUris.length > 0) {
        const selectedPhotoUri = photoSelectResult.photoUris[0];
        // ç›´æ¥æ›¿æ¢ç°æœ‰å›¾ç‰‡
        this.photoUri = selectedPhotoUri;
        this.photoCount = 1; // é‡ç½®ä¸º1ï¼Œå› ä¸ºåªå…è®¸ä¸€å¼ å›¾ç‰‡
      } else {
        prompt.showToast({ message: 'æœªé€‰æ‹©ä»»ä½•å›¾ç‰‡', duration: 2000 });
      }
    } catch (error) {
      prompt.showToast({ message: 'å›¾ç‰‡é€‰æ‹©å¤±è´¥', duration: 2000 });
      console.error('å›¾ç‰‡é€‰æ‹©å¼‚å¸¸:', error);
    }
  }
  // æ·»åŠ çš„æ¥å£
  private async loadSamplesFromServer() {
    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        `https://api.suoeryun.com/ifood/jeecg-school/school/xxReservedSample/list`, // ç¤ºä¾‹æ¥å£åœ°å€
        {
          method: http.RequestMethod.GET,
          header: {
            'Content-Type': 'application/json',
            'X-Access-Token': this.receivedToken,
            'Tenant-Id': this.tenantId.toString()
          }
        }
      );
      if (response.responseCode === 200) {
        const jsonData = JSON.parse(response.result as string) as SampleResponse;
        if (jsonData.code === 200 && jsonData.result) {
          // this.samples = jsonData.result || [];
          this.samples =  [jsonData.result]
          console.log('this.samples:', this.samples)
        } else {
          console.error('è·å–æ•°æ®å¤±è´¥:', jsonData.message);
        }
      } else {
        console.error('HTTP è¯·æ±‚å¤±è´¥:', response.responseCode);
      }
    } catch (error) {
      console.error('è¯·æ±‚å¼‚å¸¸:', error);
    }
  }
  // è¡¨å•è¡Œå°è£…
  @Builder
  private formRow(label: string, required: boolean) {
    Row(){
      Text(label)
        .fontWeight(FontWeight.Bold)
      if ((required?'*':'')) {
        Text('*')
          .fontColor('#ff0000')
          .margin({ left: 4 });
      }
    }
    .margin({ top: 8, bottom: 8 })
    .width('35%')
    .alignItems(VerticalAlign.Center)
  }

  // å›¾ç‰‡ä¸Šä¼ è¡Œå°è£…
  @Builder
  private formImageRow(label: string, required: boolean, images: string[], max: number, onChange: (imgs: string[]) => void) {
    Column(){
      Row() {
        Text(label)
          .fontWeight(FontWeight.Bold)
          .width('45%')
        if ((required?'*':'')) {
          Text('*')
            .fontColor('#ff0000')
            .margin({ left: 4 });
        }
        Text(`${images.length}/${max}`)
          .fontColor('#888')
          .width('40%')
          .textAlign(TextAlign.End)
      }
      .margin({top: 5, bottom: 5 })
      Row() {
        if (this.photoUri) {
          Stack() {
            Image(this.photoUri)
              .width(100)
              .height(100)
              .borderRadius(8)
              .objectFit(ImageFit.Cover)

            // åˆ é™¤æŒ‰é’®
            Button({ type: ButtonType.Circle }) {
              Image($r('app.media.error'))
                .width(20)
                .height(20)
            }
            .width(24)
            .height(24)
            .position({ x: 80, y: 0 })
            .backgroundColor('#FF0000')
            .onClick(() => {
              this.photoUri = '';
              this.photoCount = 0;
            })
          }
          .margin({ right: 10 })
        }

        // ä¸Šä¼ å›¾ç‰‡æŒ‰é’®
        Image($r('app.media.evidence_add'))
          .width(100)
          .height(100)
          .onClick(async () => {
            this.openGallery();
            const phAccessHelper = photoAccessHelper.getPhotoAccessHelper(getContext())
            const predicates = new dataSharePredicates.DataSharePredicates
            const fatcResult = await phAccessHelper.getAssets({
              fetchColumns: [],
              predicates: predicates
            })
            this.photoCount = fatcResult.getCount()
          })
      }
      .margin({top: 5, bottom: 5 })
    }
    .margin({ top: 8, bottom: 8 })
    .width('100%')
  }

  // æ—¥æœŸé€‰æ‹©
  private showDatePicker() {
    DatePickerDialog.show({
      start: new Date('2020-01-01'),
      end: new Date('2030-12-31'),
      selected: new Date(),
      onAccept: (value: DatePickerResult) => {
        const year = value.year ?? new Date().getFullYear()
        const month = value.month ?? new Date().getMonth() + 1
        const day = value.day ?? new Date().getDate()
        this.sampleDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`

      }
    })
  }
  private destroyTimePicker() {
    DatePickerDialog.show({
      start: new Date('2020-01-01'),
      end: new Date('2030-12-31'),
      selected: new Date(),
      onAccept: (value: DatePickerResult) => {
        const year = value.year ?? new Date().getFullYear()
        const month = value.month ?? new Date().getMonth() + 1
        const day = value.day ?? new Date().getDate()
        this.destroyTime = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`

      }
    })
  }

  // æ•°æ®è¿”å›
  private async submit(): Promise<void> {
    console.log('11',this.submitUnit)
    console.log('2',this.sampleDate)
    console.log('3',this.sampleType)
    console.log('4',this.mealType)
    console.log('5',this.fridgeTemp)
    console.log('6',this.dishName)
    console.log('7',this.sampleWeight)
    console.log('8',this.destroyPerson)
    console.log('9',this.destroyTime)
    console.log('10',this.sampleImages[0])
    console.log('111',this.fridgeImages[0])


    try {
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        'https://api.suoeryun.com/ifood/jeecg-school/school/xxReservedSample/add',
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Tenant-Id': this.tenantId.toString(),
            'X-Access-Token': this.receivedToken
          },
          extraData: JSON.stringify({
            // unitName: this.submitUnit,
            // date: this.sampleDate,
            // sampleType: this.sampleType,
            // mealType: this.mealType,
            // fridgeTemp: this.fridgeTemp,
            // dishName: this.dishName,
            // sampleWeight: this.sampleWeight,
            // destroyPerson: this.destroyPerson,
            // destroyTime: this.destroyTime,
            // sampleImages: this.sampleImages,
            // fridgeImages: this.fridgeImages,
            // remark: this.remark

            unitName: this.submitUnit,
            date: this.sampleDate,
            sampleType: this.sampleType,
            mealType: this.mealType,
            fridgeTemp: this.fridgeTemp,
            dishName: this.dishName,
            sampleWeight: parseFloat(this.sampleWeight) || 0,
            destroyPerson: this.destroyPerson,
            destroyTime: this.destroyTime !== 'è¯·é€‰æ‹©é”€æ¯æ—¶é—´' ? this.destroyTime : '',
            sampleImages: ["https://admin.suoeryun.com/pcUpload/1917474932601933825_1745996623568.png"],
            fridgeImages: ["https://admin.suoeryun.com/pcUpload/1917474946438942721_1745996626850.png"]

          })
        }
      );
      console.log('ResponseResult:', response.result)

      const responseString = response.result as string;
      const jsonData: SampleResponse = JSON.parse(responseString);
      console.log('ResponseCode:', jsonData.message);
      if (jsonData.code === 200) {
        const formData: SampleFormData = {
          id: jsonData.result?.id || '',
          unitName: this.submitUnit,
          date: this.sampleDate,
          sampleType: this.sampleType,
          mealType: this.mealType,
          fridgeTemp: this.fridgeTemp,
          dishName: this.dishName,
          sampleWeight: this.sampleWeight,
          destroyPerson: this.destroyPerson,
          destroyTime: this.destroyTime,
          sampleImages: ["https://admin.suoeryun.com/pcUpload/1917474932601933825_1745996623568.png"],
          fridgeImages: ["https://admin.suoeryun.com/pcUpload/1917474946438942721_1745996626850.png"],
          remark: this.remark
        };
        router.pushUrl({
          url: 'pages/remain_day',
          params: {
            formData: formData,
            token: this.receivedToken,
            relTenantIds: this.tenantId
          }
        });
        // ğŸ”¥ ä½¿ç”¨ AppStorage å­˜å‚¨æ•°æ®
        await AppStorage.set('newSampleData', JSON.stringify(formData));

      }else {
        AlertDialog.show({ message: 'æäº¤å¤±è´¥ï¼š' + jsonData.message });
      }
    } catch (error) {
      console.error('Submit Error:', error);
      AlertDialog.show({ message: 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸' });
    }

  }

}